<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talent Bloom</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHi1XRLrJq_XwalIvEKzcjV6f0cc9GW4c",
      authDomain: "talent-bloom-332a9.firebaseapp.com",
      projectId: "talent-bloom-332a9",
      storageBucket: "talent-bloom-332a9.firebasestorage.app",
      messagingSenderId: "658850120784",
      appId: "1:658850120784:web:1769b08c5a175b89f0fd55"
    };

    const app  = initializeApp(firebaseConfig);
    window.fbAuth = getAuth(app);
    window.fbDb   = getFirestore(app);
    window.fbCreateUser = createUserWithEmailAndPassword;
    window.fbSignIn     = signInWithEmailAndPassword;
    window.fbSignOut    = signOut;
    window.fbDoc        = doc;
    window.fbSetDoc     = setDoc;
    window.fbGetDoc     = getDoc;
    window.fbCollection = collection;
    window.fbGetDocs    = getDocs;
    window.fbUpdateDoc  = updateDoc;
    window.fbAddDoc     = addDoc;
    window.fbQuery      = query;
    window.fbWhere      = where;

    window.fbGoogleProvider = new GoogleAuthProvider();
    window.fbSignInWithPopup = signInWithPopup;
    window.firebaseReady = true;
    console.log("âœ… Firebase connected!");
  </script>
  <style>
    /* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020817; color: #e2e8f0; min-height: 100vh; }
    input, select, textarea, button { font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: 2px solid #6366f1; outline-offset: 1px; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #020817; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: flex; min-height: 100vh; }

    /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: 220px; background: #0a0f1e; border-right: 1px solid #1e293b;
      display: flex; flex-direction: column; padding: 20px 12px;
      position: sticky; top: 0; height: 100vh; flex-shrink: 0;
    }
    .sidebar-logo { display: flex; align-items: center; gap: 10px; padding: 4px 8px; margin-bottom: 28px; }
    .sidebar-logo-icon { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .sidebar-logo-text { font-weight: 800; font-size: 13px; color: #f1f5f9; }
    .sidebar-logo-sub  { font-size: 10px; color: #475569; font-weight: 600; }
    .nav-label { font-size: 10px; color: #334155; font-weight: 700; letter-spacing: 1.2px; padding: 0 8px; margin-bottom: 8px; }
    .nav-btn {
      display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px;
      border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 600;
      color: #64748b; width: 100%; text-align: left; margin-bottom: 2px; transition: all 0.15s;
      border-left: 2px solid transparent;
    }
    .nav-btn:hover { background: #1e293b; color: #e2e8f0; }
    .nav-btn.active { background: #6366f115; color: #818cf8; border-left: 2px solid #6366f1; }
    .sidebar-footer { margin-top: auto; border-top: 1px solid #1e293b; padding-top: 14px; }
    .sidebar-user { padding: 8px 10px; margin-bottom: 10px; }
    .sidebar-user-name { font-size: 13px; font-weight: 700; color: #e2e8f0; }
    .sidebar-user-role { font-size: 11px; color: #475569; margin-top: 2px; }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main { flex: 1; padding: 32px; overflow-y: auto; max-height: 100vh; }

    /* â”€â”€ PAGE HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 26px; font-weight: 800; color: #f1f5f9; letter-spacing: -0.5px; }
    .page-header p  { font-size: 14px; color: #64748b; margin-top: 4px; }
    .page-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }

    /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 22px; margin-bottom: 20px; }
    .stat-grid   { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
    .stat-grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 14px; }
    .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
    .stat-label { font-size: 11px; color: #64748b; font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 4px; }
    .stat-value { font-size: 28px; font-weight: 800; color: #f1f5f9; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .section-title { font-size: 15px; font-weight: 800; color: #f1f5f9; margin-bottom: 16px; }

    /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 700; transition: all 0.15s; font-family: inherit; }
    .btn:hover { filter: brightness(1.12); }
    .btn-primary { background: #6366f1; color: #fff; }
    .btn-success { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
    .btn-warning { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b40; }
    .btn-danger  { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }
    .btn-ghost   { background: #1e293b;   color: #94a3b8; }
    .btn-blue    { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; }
    .btn-sm   { padding: 6px 12px; font-size: 12px; }
    .btn-full { width: 100%; justify-content: center; }

    /* â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.4px; }
    .badge-active    { background: #22c55e18; color: #22c55e; border: 1px solid #22c55e40; }
    .badge-risk      { background: #f59e0b18; color: #f59e0b; border: 1px solid #f59e0b40; }
    .badge-completed { background: #3b82f618; color: #3b82f6; border: 1px solid #3b82f640; }
    .badge-approved  { background: #22c55e18; color: #22c55e; border: 1px solid #22c55e40; }
    .badge-pending   { background: #6b728018; color: #9ca3af; border: 1px solid #6b728040; }
    .badge-improve   { background: #f59e0b18; color: #f59e0b; border: 1px solid #f59e0b40; }
    .badge-present   { background: #22c55e18; color: #22c55e; border: 1px solid #22c55e40; }
    .badge-absent    { background: #ef444418; color: #ef4444; border: 1px solid #ef444440; }

    /* â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 6px; letter-spacing: 0.5px; text-transform: uppercase; }
    .form-input { width: 100%; background: #020817; border: 1px solid #1e293b; border-radius: 8px; padding: 10px 14px; color: #e2e8f0; font-size: 14px; font-family: inherit; }
    textarea.form-input { resize: vertical; }

    /* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap { background: #0f172a; border: 1px solid #1e293b; border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    thead tr { background: #0a0f1e; border-bottom: 1px solid #1e293b; }
    th { padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 700; color: #475569; letter-spacing: 0.8px; text-transform: uppercase; }
    td { padding: 13px 16px; border-bottom: 1px solid #1e293b40; font-size: 14px; }
    tbody tr:hover { background: #1e293b30; }
    tbody tr:last-child td { border-bottom: none; }

    /* â”€â”€ AVATAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .avatar { border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; flex-shrink: 0; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay { position: fixed; inset: 0; background: #00000090; z-index: 9000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #0f172a; border: 1px solid #1e293b; border-radius: 16px; padding: 32px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title  { font-size: 18px; font-weight: 800; color: #f1f5f9; }
    .modal-btn-row { display: flex; gap: 10px; margin-top: 8px; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast { position: fixed; bottom: 24px; right: 24px; z-index: 99999; padding: 12px 24px; border-radius: 10px; font-weight: 700; font-size: 14px; box-shadow: 0 8px 32px #00000050; }

    /* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .login-box { width: 420px; background: #0a0f1e; border: 1px solid #1e293b; border-radius: 20px; padding: 48px; box-shadow: 0 32px 64px #00000070; }
    .login-logo { text-align: center; margin-bottom: 32px; }
    .login-logo-icon { display: inline-flex; width: 60px; height: 60px; border-radius: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6); align-items: center; justify-content: center; font-size: 28px; margin-bottom: 14px; }
    .login-logo h2 { font-size: 22px; font-weight: 800; color: #f1f5f9; }
    .login-logo p  { font-size: 13px; color: #475569; margin-top: 4px; }
    .role-toggle { display: flex; background: #020817; border-radius: 10px; padding: 4px; margin-bottom: 22px; border: 1px solid #1e293b; }
    .role-btn { flex: 1; padding: 10px; border: none; cursor: pointer; border-radius: 7px; font-weight: 700; font-size: 13px; background: transparent; color: #475569; transition: all 0.15s; font-family: inherit; }
    .role-btn.active { background: #6366f1; color: #fff; }
    .hint-box { background: #6366f110; border: 1px solid #6366f130; border-radius: 10px; padding: 10px 14px; margin-bottom: 20px; font-size: 12px; color: #818cf8; line-height: 1.7; }
    .login-error { background: #ef444415; border: 1px solid #ef444440; color: #ef4444; border-radius: 8px; padding: 10px 14px; font-size: 13px; margin-bottom: 14px; }

    /* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .feedback-block { margin-top: 10px; background: #0a0f1e; border-radius: 8px; padding: 12px 14px; border-left: 3px solid #6366f1; }
    .feedback-label { font-size: 11px; font-weight: 700; color: #6366f1; margin-bottom: 4px; letter-spacing: 0.5px; }
    .att-chip { display: inline-block; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: 600; margin: 3px; }
    .att-present { background: #22c55e15; color: #22c55e; border: 1px solid #22c55e40; }
    .att-absent  { background: #ef444415; color: #ef4444;  border: 1px solid #ef444440; }
    .alert-card  { background: #f59e0b06; border: 1px solid #f59e0b30; border-radius: 12px; padding: 22px; margin-bottom: 20px; }
    .alert-title { font-size: 15px; font-weight: 800; color: #f59e0b; margin-bottom: 14px; }
    .flex-row    { display: flex; align-items: center; gap: 12px; }
    .flex-1      { flex: 1; }
    .text-muted  { color: #64748b; font-size: 13px; }
    .empty-state { text-align: center; padding: 48px; color: #475569; font-size: 14px; }
    .mini-stats  { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-top: 14px; }
    .mini-stat   { background: #0a0f1e; border-radius: 10px; padding: 14px; text-align: center; }
    .mini-stat-val { font-size: 26px; font-weight: 800; }
    .mini-stat-lbl { font-size: 12px; color: #64748b; margin-top: 4px; }
    .gh-link { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: #818cf8; font-weight: 600; background: #6366f115; padding: 6px 14px; border-radius: 8px; text-decoration: none; }
    .today-box { display: flex; align-items: center; gap: 14px; padding: 16px 0; }
    .hidden { display: none !important; }
    .mt-14  { margin-top: 14px; }
    .pt-14  { padding-top: 14px; }
    .border-t { border-top: 1px solid #1e293b; }
    /* â”€â”€ SIGNUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #signup-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .signup-box { width: 480px; background: #0a0f1e; border: 1px solid #1e293b; border-radius: 20px; padding: 48px; box-shadow: 0 32px 64px #00000070; }
    .auth-switch { text-align: center; margin-top: 20px; font-size: 13px; color: #475569; }
    .auth-switch a { color: #818cf8; font-weight: 700; cursor: pointer; text-decoration: none; }
    .auth-switch a:hover { color: #a5b4fc; }
    .btn-google { background: #fff; color: #1f2937; border: 1px solid #d1d5db; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 14px; transition: all 0.15s; font-family: inherit; }
    .btn-google:hover { background: #f9fafb; box-shadow: 0 2px 8px #00000020; }
    .btn-google img { width: 20px; height: 20px; }
    .or-divider { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; color: #334155; font-size: 12px; font-weight: 600; }
    .or-divider::before, .or-divider::after { content: ""; flex: 1; height: 1px; background: #1e293b; }
    /* â”€â”€ MARK BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mark-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 800; }
    .mark-high   { background: #22c55e18; color: #22c55e; border: 1px solid #22c55e40; }
    .mark-mid    { background: #f59e0b18; color: #f59e0b; border: 1px solid #f59e0b40; }
    .mark-low    { background: #ef444418; color: #ef4444; border: 1px solid #ef444440; }
    .mark-none   { background: #6b728018; color: #9ca3af; border: 1px solid #6b728040; }
    .mark-bar-wrap { margin-top: 8px; background: #1e293b; border-radius: 99px; height: 6px; }
    .mark-bar-fill { height: 6px; border-radius: 99px; transition: width 0.4s; }

    /* â”€â”€ AUTH ENHANCEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pw-wrap { position: relative; }
    .pw-wrap .form-input { padding-right: 44px; }
    .pw-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #475569; font-size: 16px; padding: 4px; line-height: 1; }
    .pw-toggle:hover { color: #818cf8; }
    .field-hint { font-size: 11px; margin-top: 5px; font-weight: 600; }
    .field-hint.ok  { color: #22c55e; }
    .field-hint.err { color: #ef4444; }
    .field-hint.warn{ color: #f59e0b; }
    .strength-bar { display: flex; gap: 3px; margin-top: 6px; }
    .strength-seg { height: 4px; flex: 1; border-radius: 99px; background: #1e293b; transition: background 0.2s; }
    .remember-row { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .remember-row input[type="checkbox"] { width: 16px; height: 16px; accent-color: #6366f1; cursor: pointer; }
    .remember-row label { font-size: 13px; color: #64748b; cursor: pointer; font-weight: 600; }
    .lockout-bar { background: #ef444415; border: 1px solid #ef444440; border-radius: 8px; padding: 10px 14px; font-size: 13px; color: #ef4444; margin-bottom: 14px; font-weight: 600; }
    .session-badge { display: inline-flex; align-items: center; gap: 6px; background: #22c55e15; border: 1px solid #22c55e30; color: #22c55e; border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 700; margin-top: 4px; }
    .login-loading { opacity: 0.6; pointer-events: none; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #ffffff40; border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* â”€â”€ OTP VERIFICATION PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #verify-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .verify-box { width: 440px; background: #0a0f1e; border: 1px solid #1e293b; border-radius: 20px; padding: 48px; box-shadow: 0 32px 64px #00000070; }
    .otp-wrap { display: flex; gap: 10px; justify-content: center; margin: 24px 0; }
    .otp-digit { width: 52px; height: 60px; background: #020817; border: 2px solid #1e293b; border-radius: 12px; color: #f1f5f9; font-size: 26px; font-weight: 800; text-align: center; font-family: inherit; transition: border-color 0.15s; }
    .otp-digit:focus { border-color: #6366f1; outline: none; }
    .otp-digit.filled { border-color: #6366f150; }
    .otp-digit.error  { border-color: #ef4444; animation: shake 0.4s ease; }
    .verify-email-display { background: #6366f110; border: 1px solid #6366f130; border-radius: 10px; padding: 10px 16px; text-align: center; font-size: 14px; color: #818cf8; font-weight: 700; margin-bottom: 8px; word-break: break-all; }
    .resend-row { text-align: center; font-size: 13px; color: #475569; margin-top: 14px; }
    .resend-row a { color: #818cf8; font-weight: 700; cursor: pointer; }
    .resend-row a:hover { color: #a5b4fc; }
    .resend-row a.disabled { color: #334155; pointer-events: none; cursor: default; }
    .otp-expires { text-align: center; font-size: 12px; color: #475569; margin-top: 6px; }
    .emailjs-setup { background: #f59e0b08; border: 1px solid #f59e0b30; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; font-size: 12px; color: #f59e0b; line-height: 1.8; }
    .emailjs-setup strong { color: #fbbf24; }
    .emailjs-setup code { background: #f59e0b15; padding: 1px 6px; border-radius: 4px; font-family: monospace; font-size: 11px; }
  </style>
</head>
<body>

<!-- â•â•â•â• LOADING SCREEN â•â•â•â• -->
<div id="loading-screen" style="position:fixed;inset:0;background:#020817;z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;">
  <div style="width:48px;height:48px;border:3px solid #1e293b;border-top-color:#6366f1;border-radius:50%;animation:spin 0.7s linear infinite;"></div>
  <div style="color:#475569;font-size:14px;font-weight:600;">Loading Talent Bloom IMSâ€¦</div>
</div>

<!-- â•â•â•â• OTP VERIFICATION PAGE â•â•â•â• -->
<div id="verify-page" class="hidden">
  <div class="verify-box">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ“§</div>
      <h2>Verify Your Email</h2>
      <p>We sent a 6-digit code to</p>
    </div>
    <div class="verify-email-display" id="verify-email-display">â€”</div>
    <p style="text-align:center;font-size:13px;color:#64748b;margin-bottom:4px;">Enter the code below to activate your account</p>
    <div class="otp-wrap" id="otp-wrap">
      <input class="otp-digit" id="otp0" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,0)" oninput="otpInput(event,0)"/>
      <input class="otp-digit" id="otp1" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,1)" oninput="otpInput(event,1)"/>
      <input class="otp-digit" id="otp2" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,2)" oninput="otpInput(event,2)"/>
      <input class="otp-digit" id="otp3" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,3)" oninput="otpInput(event,3)"/>
      <input class="otp-digit" id="otp4" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,4)" oninput="otpInput(event,4)"/>
      <input class="otp-digit" id="otp5" maxlength="1" inputmode="numeric" pattern="[0-9]" onkeydown="otpKey(event,5)" oninput="otpInput(event,5)"/>
    </div>
    <div class="otp-expires" id="otp-expires"></div>
    <div class="login-error hidden" id="verify-error"></div>
    <button class="btn btn-primary btn-full" id="verify-btn" style="padding:14px;" onclick="doVerify()">Verify &amp; Activate â†’</button>
    <div class="resend-row">
      Didn't receive it? <a id="resend-link" onclick="resendOtp()">Resend code</a>
      <span id="resend-timer" class="hidden"> in <span id="resend-countdown">60</span>s</span>
    </div>
    <div class="auth-switch" style="margin-top:14px;"><a onclick="cancelVerify()">â† Back to Sign In</a></div>
  </div>
</div>

<!-- â•â•â•â• SIGNUP PAGE â•â•â•â• -->
<div id="signup-page" class="hidden">
  <div class="signup-box">
    <div class="login-logo">
      <div class="login-logo-icon">âœï¸</div>
      <h2>Create Your Account</h2>
      <p>Join the Talent Bloom Internship Programme</p>
    </div>
    <div class="login-error hidden" id="signup-error"></div>
    <div class="form-group">
      <label class="form-label">Full Name</label>
      <input class="form-input" id="su-name" placeholder="e.g. Thandeka Zulu"
        oninput="validateSignupName()" autocomplete="name"/>
      <div class="field-hint hidden" id="su-name-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Email Address</label>
      <input class="form-input" id="su-email" type="email" placeholder="e.g. thandeka@email.com"
        oninput="validateSignupEmail()" autocomplete="email"/>
      <div class="field-hint hidden" id="su-email-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Track / Programme</label>
      <select class="form-input" id="su-track">
        <option value="">â€” Select a track â€”</option>
        <option>Software Development</option>
        <option>Data Science</option>
        <option>UX Design</option>
        <option>Cloud Computing</option>
        <option>Cybersecurity</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <div class="pw-wrap">
        <input class="form-input" id="su-password" type="password" placeholder="Min. 8 characters"
          oninput="validateSignupPassword()" autocomplete="new-password"/>
        <button class="pw-toggle" type="button" onclick="togglePw('su-password',this)" title="Show/hide">ğŸ‘</button>
      </div>
      <div class="strength-bar" id="su-strength-bar">
        <div class="strength-seg" id="ss1"></div>
        <div class="strength-seg" id="ss2"></div>
        <div class="strength-seg" id="ss3"></div>
        <div class="strength-seg" id="ss4"></div>
      </div>
      <div class="field-hint hidden" id="su-pw-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Confirm Password</label>
      <div class="pw-wrap">
        <input class="form-input" id="su-confirm" type="password" placeholder="Repeat your password"
          oninput="validateSignupConfirm()" onkeydown="if(event.key==='Enter') doSignup()" autocomplete="new-password"/>
        <button class="pw-toggle" type="button" onclick="togglePw('su-confirm',this)" title="Show/hide">ğŸ‘</button>
      </div>
      <div class="field-hint hidden" id="su-confirm-hint"></div>
    </div>
    <button class="btn btn-primary btn-full" id="signup-btn" style="padding:14px;" onclick="safeCall(doSignup)">Create Account â†’</button>
    <div class="or-divider" style="margin-top:14px;">or</div>
    <button class="btn-google" onclick="safeCall(doGoogleSignIn)">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"/>
      Continue with Google
    </button>
    <div class="auth-switch" style="margin-top:16px;">Already have an account? <a onclick="safeCall(showLogin)">Sign In</a></div>
  </div>
</div>

<!-- â•â•â•â• LOGIN PAGE â•â•â•â• -->
<div id="login-page">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ“</div>
      <h2>Talent Bloom</h2>
      <p>Student Portal</p>
    </div>

    <div class="role-toggle">
      <button class="role-btn active" id="role-admin-btn"   onclick="setRole('admin')">ğŸ‘” Admin</button>
      <button class="role-btn"        id="role-student-btn" onclick="setRole('student')">ğŸ’ Student</button>
    </div>

    <div class="login-error hidden" id="login-error"></div>
    <div class="lockout-bar hidden" id="lockout-bar"></div>

    <div class="form-group">
      <label class="form-label">Email Address</label>
      <input class="form-input" id="login-email" type="email" placeholder="Enter your email"
        oninput="clearLoginError()" autocomplete="email"/>
      <div class="field-hint hidden" id="login-email-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <div class="pw-wrap">
        <input class="form-input" id="login-password" type="password" placeholder="Enter your password"
          onkeydown="if(event.key==='Enter') doLogin()" oninput="clearLoginError()" autocomplete="current-password"/>
        <button class="pw-toggle" type="button" onclick="togglePw('login-password',this)" title="Show/hide password">ğŸ‘</button>
      </div>
    </div>
    <div class="remember-row">
      <input type="checkbox" id="remember-me"/>
      <label for="remember-me">Keep me signed in</label>
    </div>
    <button class="btn btn-primary btn-full" id="login-btn" style="padding:14px;" onclick="safeCall(doLogin)">Sign In â†’</button>
    <div class="or-divider" style="margin-top:14px;">or</div>
    <button class="btn-google" onclick="safeCall(doGoogleSignIn)">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"/>
      Continue with Google
    </button>
    <div class="auth-switch" style="margin-top:16px;">New student? <a onclick="safeCall(showSignup)">Create an account</a></div>
  </div>
</div>

<!-- â•â•â•â• MAIN APP â•â•â•â• -->
<div id="app" class="hidden">
  <aside id="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">ğŸ“</div>
      <div>
        <div class="sidebar-logo-text">Talent Bloom</div>
        <div class="sidebar-logo-sub">Student Portal</div>
      </div>
    </div>
    <div class="nav-label">MENU</div>
    <div id="sidebar-nav"></div>
    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-user-name" id="sidebar-username"></div>
        <div class="sidebar-user-role"  id="sidebar-userrole"></div>
        <div class="session-badge" id="session-badge">ğŸ”’ Authenticated</div>
      </div>
      <button class="btn btn-danger btn-full" onclick="doLogout()">Sign Out</button>
    </div>
  </aside>
  <main id="main"></main>
</div>

<!-- â•â•â•â• TOAST â•â•â•â• -->
<div id="toast" class="hidden"></div>

<!-- â•â•â•â• MODAL â•â•â•â• -->
<div id="modal" class="hidden">
  <div class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="modal-title"></div>
        <button class="btn btn-ghost btn-sm" onclick="closeModal()">âœ•</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATABASE  (Users / Attendance / Projects)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var DB = {
  users: [
    { id:1, name:"Admin User",     email:"admin@capaciti.org",   password:"admin123",   role:"admin",   mentor_id:null, status:null,       track:null },
    { id:2, name:"Thandeka Zulu",  email:"thandeka@student.org", password:"student123", role:"student", mentor_id:1,    status:"Active",    track:"Software Development" },
    { id:3, name:"Sipho Mahlangu", email:"sipho@student.org",    password:"student123", role:"student", mentor_id:2,    status:"At Risk",   track:"Data Science" },
    { id:4, name:"Amahle Dlamini", email:"amahle@student.org",   password:"student123", role:"student", mentor_id:1,    status:"Active",    track:"Software Development" },
    { id:5, name:"Nomsa Khumalo",  email:"nomsa@student.org",    password:"student123", role:"student", mentor_id:3,    status:"Completed", track:"UX Design" },
    { id:6, name:"Kagiso Sithole", email:"kagiso@student.org",   password:"student123", role:"student", mentor_id:2,    status:"At Risk",   track:"Cloud Computing" }
  ],
  mentors: [
    { id:1, name:"Mr. Nkosi" },
    { id:2, name:"Ms. Petersen" },
    { id:3, name:"Ms. Van Wyk" }
  ],
  attendance: [
    { id:1,  student_id:2, date:"2026-02-20", status:"Present" },
    { id:2,  student_id:2, date:"2026-02-19", status:"Present" },
    { id:3,  student_id:2, date:"2026-02-18", status:"Absent"  },
    { id:4,  student_id:2, date:"2026-02-17", status:"Present" },
    { id:5,  student_id:3, date:"2026-02-20", status:"Absent"  },
    { id:6,  student_id:3, date:"2026-02-19", status:"Absent"  },
    { id:7,  student_id:3, date:"2026-02-18", status:"Present" },
    { id:8,  student_id:4, date:"2026-02-20", status:"Present" },
    { id:9,  student_id:4, date:"2026-02-19", status:"Present" },
    { id:10, student_id:5, date:"2026-02-20", status:"Present" },
    { id:11, student_id:6, date:"2026-02-20", status:"Absent"  },
    { id:12, student_id:6, date:"2026-02-19", status:"Present" }
  ],
  projects: [
    { id:1, student_id:2, title:"REST API with Node.js",   github_link:"https://github.com/thandeka/rest-api",   description:"Built a full REST API using Express and MongoDB",        feedback:"Great structure, improve error handling.", status:"Approved",          submitted:"2026-02-18", mark:78 },
    { id:2, student_id:2, title:"React Dashboard",         github_link:"https://github.com/thandeka/dashboard",  description:"Interactive admin dashboard with charts",                feedback:"",                                         status:"Pending",           submitted:"2026-02-21", mark:null },
    { id:3, student_id:3, title:"Data Analysis Script",    github_link:"https://github.com/sipho/data-analysis", description:"Python script for cleaning and analysing CSV data",      feedback:"Needs more documentation.",               status:"Needs Improvement", submitted:"2026-02-15", mark:52 },
    { id:4, student_id:4, title:"Authentication System",   github_link:"https://github.com/amahle/auth-system",  description:"JWT-based auth with Node.js and bcrypt",                feedback:"Excellent implementation!",                status:"Approved",          submitted:"2026-02-19", mark:94 },
    { id:5, student_id:5, title:"UX Case Study",           github_link:"https://github.com/nomsa/ux-case",       description:"Full UX case study with Figma prototype",               feedback:"Outstanding work. Well done!",              status:"Approved",          submitted:"2026-02-10", mark:89 }
  ]
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var currentUser  = null;
var activeNav    = "dashboard";
var selectedRole = "admin";
var TODAY        = new Date().toISOString().split("T")[0];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getStudents()       { return DB.users.filter(function(u){ return u.role==="student"; }); }
function getMentorName(id)   { var m=DB.mentors.find(function(m){ return m.id===id; }); return m?m.name:"â€”"; }
function getAttendance(sid)  { return DB.attendance.filter(function(a){ return a.student_id===sid; }); }
function getProjects(sid)    { return DB.projects.filter(function(p){ return p.student_id===sid; }); }
function getTodayAtt(sid)    { return DB.attendance.find(function(a){ return a.student_id===sid && a.date===TODAY; }); }
function getAttPct(sid) {
  var r=getAttendance(sid); if(!r.length) return 0;
  return Math.round(r.filter(function(x){ return x.status==="Present"; }).length/r.length*100);
}
var AVATAR_COLORS = ["#6366f1","#22c55e","#f59e0b","#3b82f6","#ec4899","#14b8a6"];
function avatarColor(name) { return AVATAR_COLORS[name.charCodeAt(0)%AVATAR_COLORS.length]; }
function makeAvatar(name, size) {
  size=size||36;
  var i=name.split(" ").map(function(w){ return w[0]; }).join("").slice(0,2).toUpperCase();
  var c=avatarColor(name);
  return '<div class="avatar" style="width:'+size+'px;height:'+size+'px;font-size:'+(size*.35)+'px;background:'+c+'25;border:2px solid '+c+'50;color:'+c+';">'+i+'</div>';
}
function statusBadge(s)  { var m={"Active":"badge-active","At Risk":"badge-risk","Completed":"badge-completed"}; return '<span class="badge '+(m[s]||"badge-pending")+'">'+s+'</span>'; }
function projectBadge(s) { var m={"Approved":"badge-approved","Pending":"badge-pending","Needs Improvement":"badge-improve"}; return '<span class="badge '+(m[s]||"badge-pending")+'">'+s+'</span>'; }
function markBadge(mark) {
  if(mark===null||mark===undefined) return '<span class="mark-badge mark-none">â€” Not Marked</span>';
  var cls=mark>=75?"mark-high":mark>=50?"mark-mid":"mark-low";
  var emoji=mark>=75?"ğŸ†":mark>=50?"ğŸ“":"âš ï¸";
  return '<span class="mark-badge '+cls+'">'+emoji+' '+mark+'/100</span>';
}
function markBarHTML(mark) {
  if(mark===null||mark===undefined) return "";
  var color=mark>=75?"#22c55e":mark>=50?"#f59e0b":"#ef4444";
  return '<div class="mark-bar-wrap"><div class="mark-bar-fill" style="width:'+mark+'%;background:'+color+';"></div></div>';
}
function markLabel(mark) {
  if(mark===null||mark===undefined) return "";
  if(mark>=75) return "Distinction";
  if(mark>=50) return "Pass";
  return "Below Pass";
}
function attBadge(s)     { return s==="Present"?'<span class="badge badge-present">Present</span>':'<span class="badge badge-absent">Absent</span>'; }
function statCardHTML(icon,label,value,color) {
  return '<div class="stat-card"><div class="stat-icon" style="background:'+color+'20;">'+icon+'</div>'
       + '<div><div class="stat-label">'+label+'</div><div class="stat-value">'+value+'</div></div></div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showToast(msg, type) {
  var t=document.getElementById("toast");
  t.textContent=msg;
  t.style.background=(type==="error")?"#ef4444":"#22c55e";
  t.style.color="#fff";
  t.classList.remove("hidden");
  setTimeout(function(){ t.classList.add("hidden"); },3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(title, body) {
  document.getElementById("modal-title").textContent=title;
  document.getElementById("modal-body").innerHTML=body;
  document.getElementById("modal").classList.remove("hidden");
}
function closeModal(e) {
  if(!e || e.target.classList.contains("modal-overlay"))
    document.getElementById("modal").classList.add("hidden");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTHENTICATION SYSTEM
   - SHA-256 password hashing (Web Crypto)
   - Session tokens stored in localStorage
   - Rate limiting / lockout after 5 fails
   - Remember Me (persistent vs session)
   - Real-time field validation
   - Show/hide password toggle
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Password Hashing â”€â”€ */
async function sha256(str) {
  var buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,"0"); }).join("");
}

/* Pre-hash all demo passwords on startup so DB never stores plaintext */
var AUTH_READY = false;

/* Safe wrapper â€” queues calls until auth is ready */
function safeCall(fn) {
  if(AUTH_READY) { fn(); return; }
  var wait = setInterval(function(){
    if(AUTH_READY){ clearInterval(wait); fn(); }
  }, 100);
}
async function initAuth() {
  for(var i=0;i<DB.users.length;i++){
    var u=DB.users[i];
    if(u.password && !u.password.startsWith("$hash$")){
      u.password = "$hash$" + await sha256(u.password);
    }
  }
  AUTH_READY = true;
  /* Restore session */
  restoreSession();
}

/* â”€â”€ Session Management â”€â”€ */
var SESSION_KEY   = "talentbloom_session";
var REMEMBER_KEY  = "talentbloom_remember";

function createSession(user, remember) {
  var token = btoa(user.id + ":" + Date.now() + ":" + Math.random());
  var session = { token: token, userId: user.id, userEmail: user.email, role: user.role, ts: Date.now() };
  if(remember){
    localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    localStorage.setItem(REMEMBER_KEY, "1");
  } else {
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem(REMEMBER_KEY);
  }
  return token;
}

function getStoredSession() {
  var raw = localStorage.getItem(SESSION_KEY) || sessionStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
  localStorage.removeItem(REMEMBER_KEY);
  sessionStorage.removeItem(SESSION_KEY);
}

function restoreSession() {
  var sess = getStoredSession();
  if(!sess) return;
  /* Match by id OR email (Firebase uses string IDs) */
  var user = DB.users.find(function(u){
    return (u.id === sess.userId || u.email === sess.userEmail) && u.role === sess.role;
  });
  if(!user) return;
  /* Session is valid â€” auto login */
  launchApp(user, false);
}

/* â”€â”€ Rate Limiting â”€â”€ */
var loginAttempts = {};
var MAX_ATTEMPTS  = 5;
var LOCKOUT_MS    = 30 * 1000; /* 30 seconds */

function isLockedOut(email) {
  var rec = loginAttempts[email];
  if(!rec) return false;
  if(rec.count >= MAX_ATTEMPTS) {
    var elapsed = Date.now() - rec.lastAttempt;
    if(elapsed < LOCKOUT_MS) return Math.ceil((LOCKOUT_MS - elapsed)/1000);
    /* Lockout expired, reset */
    delete loginAttempts[email];
  }
  return false;
}
function recordFailedAttempt(email) {
  if(!loginAttempts[email]) loginAttempts[email] = { count:0 };
  loginAttempts[email].count++;
  loginAttempts[email].lastAttempt = Date.now();
}
function clearAttempts(email) { delete loginAttempts[email]; }

/* â”€â”€ UI Helpers â”€â”€ */
function togglePw(id, btn) {
  var inp = document.getElementById(id);
  if(inp.type === "password"){ inp.type="text"; btn.textContent="ğŸ™ˆ"; }
  else { inp.type="password"; btn.textContent="ğŸ‘"; }
}
function clearLoginError() {
  document.getElementById("login-error").classList.add("hidden");
}
function setHint(id, msg, type) {
  var el = document.getElementById(id);
  if(!el) return;
  if(!msg){ el.classList.add("hidden"); return; }
  el.textContent = msg;
  el.className = "field-hint " + type;
  el.classList.remove("hidden");
}

/* â”€â”€ Real-time Signup Validation â”€â”€ */
function validateSignupName() {
  var v = document.getElementById("su-name").value.trim();
  if(!v) return setHint("su-name-hint","","");
  if(v.length < 2) setHint("su-name-hint","Name is too short","err");
  else if(!/\s/.test(v)) setHint("su-name-hint","Please enter your full name","warn");
  else setHint("su-name-hint","âœ“ Looks good","ok");
}
function validateSignupEmail() {
  var v = document.getElementById("su-email").value.trim();
  if(!v) return setHint("su-email-hint","","");
  var ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  if(!ok){ setHint("su-email-hint","Enter a valid email address","err"); return; }
  var taken = DB.users.find(function(u){ return u.email===v; });
  if(taken) setHint("su-email-hint","This email is already registered","err");
  else setHint("su-email-hint","âœ“ Email available","ok");
}
function validateSignupPassword() {
  var v = document.getElementById("su-password").value;
  if(!v) return setHint("su-pw-hint","","");
  var score=0, segs=["ss1","ss2","ss3","ss4"];
  if(v.length>=8) score++;
  if(/[A-Z]/.test(v)) score++;
  if(/[0-9]/.test(v)) score++;
  if(/[^A-Za-z0-9]/.test(v)) score++;
  var colors=["#ef4444","#f59e0b","#f59e0b","#22c55e"];
  var labels=["Too weak","Weak","Good","Strong"];
  segs.forEach(function(s,i){
    document.getElementById(s).style.background = i<score ? colors[score-1] : "#1e293b";
  });
  var msgs=[null,"Add uppercase, numbers or symbols","Getting strongerâ€¦","Strong password âœ“","Strong password âœ“"];
  setHint("su-pw-hint", msgs[score]||"Min 8 characters required", score>=3?"ok":score>=2?"warn":"err");
  validateSignupConfirm();
}
function validateSignupConfirm() {
  var p = document.getElementById("su-password").value;
  var c = document.getElementById("su-confirm").value;
  if(!c) return setHint("su-confirm-hint","","");
  if(p===c) setHint("su-confirm-hint","âœ“ Passwords match","ok");
  else      setHint("su-confirm-hint","Passwords do not match","err");
}

/* â”€â”€ Password Strength Score â”€â”€ */
function pwStrength(v) {
  var s=0;
  if(v.length>=8) s++;
  if(/[A-Z]/.test(v)) s++;
  if(/[0-9]/.test(v)) s++;
  if(/[^A-Za-z0-9]/.test(v)) s++;
  return s;
}

/* â”€â”€ SET ROLE â”€â”€ */
function setRole(role) {
  selectedRole=role;
  document.getElementById("role-admin-btn").className  ="role-btn"+(role==="admin"  ?" active":"");
  document.getElementById("role-student-btn").className="role-btn"+(role==="student"?" active":"");
}

/* â”€â”€ LOGIN â”€â”€ */
async function doLogin() {
  if(!AUTH_READY){ showToast("Initialisingâ€¦","error"); return; }
  var email    = document.getElementById("login-email").value.trim();
  var pass     = document.getElementById("login-password").value;
  var remember = document.getElementById("remember-me").checked;
  var errEl    = document.getElementById("login-error");
  var lockEl   = document.getElementById("lockout-bar");
  var btn      = document.getElementById("login-btn");

  errEl.classList.add("hidden");
  lockEl.classList.add("hidden");

  /* Basic input check */
  if(!email || !pass){
    errEl.textContent = "Please enter your email and password.";
    errEl.classList.remove("hidden"); return;
  }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    errEl.textContent = "Please enter a valid email address.";
    errEl.classList.remove("hidden"); return;
  }

  /* Lockout check */
  var wait = isLockedOut(email);
  if(wait){
    lockEl.textContent = "â›” Too many failed attempts. Try again in "+wait+" seconds.";
    lockEl.classList.remove("hidden"); return;
  }

  /* Loading state */
  btn.innerHTML = '<span class="spinner"></span> Signing inâ€¦';
  btn.classList.add("login-loading");

  var hashed = "$hash$" + await sha256(pass);
  var found  = DB.users.find(function(u){
    return u.email===email && u.password===hashed && u.role===selectedRole;
  });

  btn.innerHTML = "Sign In â†’";
  btn.classList.remove("login-loading");

  if(found){
    clearAttempts(email);
    /* Also sign into Firebase if available */
    if(window.fbAuth && window.fbSignIn) {
      window.fbSignIn(window.fbAuth, email, pass).catch(function(e){
        console.log("Firebase login note:", e.message);
      });
    }
    createSession(found, remember);
    launchApp(found, true);
  } else {
    recordFailedAttempt(email);
    var rec = loginAttempts[email]||{count:0};
    var left = MAX_ATTEMPTS - rec.count;
    if(left <= 0){
      lockEl.textContent = "â›” Account locked for 30 seconds due to too many failed attempts.";
      lockEl.classList.remove("hidden");
    } else {
      errEl.textContent = "Invalid email or password. " + left + " attempt"+(left===1?"":"s")+" remaining.";
      errEl.classList.remove("hidden");
    }
    /* Shake animation */
    var box = document.querySelector("#login-page .login-box");
    box.style.animation="none"; box.offsetHeight;
    box.style.animation="shake 0.4s ease";
  }
}

/* â”€â”€ LAUNCH APP â”€â”€ */
function launchApp(user, animate) {
  currentUser = user;
  document.getElementById("login-page").classList.add("hidden");
  document.getElementById("signup-page").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("login-error").classList.add("hidden");
  document.getElementById("sidebar-username").textContent = user.name;
  document.getElementById("sidebar-userrole").textContent = user.role==="admin"?"ğŸ‘” Administrator":"ğŸ’ Student";
  activeNav = "dashboard";
  buildSidebar();
  renderPage();
  if(animate) showToast("Welcome back, "+user.name.split(" ")[0]+"! ğŸ‘‹");
}

/* â”€â”€ LOGOUT â”€â”€ */
function doLogout() {
  clearSession();
  currentUser = null;
  document.getElementById("app").classList.add("hidden");
  document.getElementById("login-page").classList.remove("hidden");
  document.getElementById("signup-page").classList.add("hidden");
  document.getElementById("login-email").value = "";
  document.getElementById("login-password").value = "";
  document.getElementById("login-error").classList.add("hidden");
  document.getElementById("lockout-bar").classList.add("hidden");
}

/* â”€â”€ SHOW SIGNUP / SHOW LOGIN â”€â”€ */
function showSignup() {
  document.getElementById("login-page").classList.add("hidden");
  document.getElementById("signup-page").classList.remove("hidden");
  document.getElementById("signup-error").classList.add("hidden");
}
function showLogin() {
  document.getElementById("signup-page").classList.add("hidden");
  document.getElementById("login-page").classList.remove("hidden");
  document.getElementById("login-error").classList.add("hidden");
}

/* â”€â”€ SIGNUP â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆ  EMAILJS CONFIGURATION  â–ˆâ–ˆâ–ˆâ–ˆ
   
   HOW TO SET UP (free â€” takes 2 minutes):
   1. Go to https://www.emailjs.com and sign up
   2. Add an Email Service (Gmail, Outlook, etc.)
      â†’ copy the Service ID into EMAILJS_SERVICE_ID
   3. Create an Email Template with these variables:
        {{to_email}}   â€” recipient address
        {{to_name}}    â€” recipient name
        {{otp_code}}   â€” the 6-digit code
        {{app_name}}   â€” "Talent Bloom IMS"
      â†’ copy the Template ID into EMAILJS_TEMPLATE_ID
   4. Go to Account â†’ Public Key
      â†’ copy it into EMAILJS_PUBLIC_KEY
   5. Save and reload â€” email verification is live!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var EMAILJS_SERVICE_ID  = "service_5naq8ws";
var EMAILJS_TEMPLATE_ID = "template_h26vosu";
var EMAILJS_PUBLIC_KEY  = "hglbzmciv78X1P3Yz";

var EMAILJS_CONFIGURED = (
  EMAILJS_SERVICE_ID  !== "YOUR_SERVICE_ID" &&
  EMAILJS_TEMPLATE_ID !== "YOUR_TEMPLATE_ID" &&
  EMAILJS_PUBLIC_KEY  !== "YOUR_PUBLIC_KEY"
);

/* â”€â”€ OTP State â”€â”€ */
var pendingUser   = null;   /* user object waiting for verification */
var currentOtp    = null;   /* 6-digit string */
var otpExpiry     = null;   /* timestamp */
var otpExpiryTimer= null;
var resendTimer   = null;
var OTP_TTL_MS    = 10 * 60 * 1000;  /* 10 minutes */
var RESEND_WAIT   = 60;               /* seconds */

/* â”€â”€ Generate OTP â”€â”€ */
function generateOtp() {
  return String(Math.floor(100000 + Math.random() * 900000));
}

/* â”€â”€ Send OTP via EmailJS â”€â”€ */
async function sendOtpEmail(user, otp) {
  if(!EMAILJS_CONFIGURED) {
    /* Dev mode: show OTP in a toast so you can still test */
    showToast("ğŸ“§ Dev mode â€” OTP: " + otp, "info");
    console.log("EmailJS not configured. OTP for testing:", otp);
    return { status: 200 };
  }
  emailjs.init(EMAILJS_PUBLIC_KEY);
  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
    email    : user.email,
    passcode : otp,
    time     : "10 minutes",
    to_name  : user.name,
    app_name : "Talent Bloom Talent Bloom System"
  });
}

/* â”€â”€ Show verify page â”€â”€ */
function showVerifyPage(user) {
  /* Hide other pages */
  document.getElementById("signup-page").classList.add("hidden");
  document.getElementById("login-page").classList.add("hidden");
  document.getElementById("verify-page").classList.remove("hidden");

  /* Set email display */
  document.getElementById("verify-email-display").textContent = user.email;

  /* Clear OTP inputs */
  for(var i=0;i<6;i++){
    var el=document.getElementById("otp"+i);
    el.value=""; el.className="otp-digit";
  }
  document.getElementById("verify-error").classList.add("hidden");
  document.getElementById("otp0").focus();

  /* Start expiry countdown */
  startOtpExpiry();
  startResendCooldown();
}

function startOtpExpiry() {
  clearInterval(otpExpiryTimer);
  otpExpiry = Date.now() + OTP_TTL_MS;
  otpExpiryTimer = setInterval(function(){
    var left = Math.max(0, otpExpiry - Date.now());
    var mins = Math.floor(left/60000);
    var secs = Math.floor((left%60000)/1000);
    var el = document.getElementById("otp-expires");
    if(el) el.textContent = left > 0
      ? "Code expires in " + mins + ":" + (secs<10?"0":"") + secs
      : "Code expired. Please request a new one.";
    if(left === 0) clearInterval(otpExpiryTimer);
  }, 1000);
}

function startResendCooldown() {
  clearInterval(resendTimer);
  var link  = document.getElementById("resend-link");
  var timer = document.getElementById("resend-timer");
  var cd    = document.getElementById("resend-countdown");
  if(!link||!timer||!cd) return;
  var secs = RESEND_WAIT;
  link.classList.add("disabled");
  timer.classList.remove("hidden");
  cd.textContent = secs;
  resendTimer = setInterval(function(){
    secs--;
    if(cd) cd.textContent = secs;
    if(secs <= 0){
      clearInterval(resendTimer);
      if(link)  link.classList.remove("disabled");
      if(timer) timer.classList.add("hidden");
    }
  }, 1000);
}

/* â”€â”€ OTP digit keyboard navigation â”€â”€ */
function otpInput(e, idx) {
  var val = e.target.value.replace(/\D/g,"");
  e.target.value = val ? val[val.length-1] : "";
  if(val && idx < 5) document.getElementById("otp"+(idx+1)).focus();
  /* Auto-submit if all filled */
  var full = "";
  for(var i=0;i<6;i++) full += document.getElementById("otp"+i).value;
  if(full.length === 6) doVerify();
}
function otpKey(e, idx) {
  if(e.key === "Backspace" && !e.target.value && idx > 0)
    document.getElementById("otp"+(idx-1)).focus();
  if(e.key === "ArrowLeft"  && idx > 0) document.getElementById("otp"+(idx-1)).focus();
  if(e.key === "ArrowRight" && idx < 5) document.getElementById("otp"+(idx+1)).focus();
}

/* â”€â”€ Verify OTP â”€â”€ */
async function doVerify() {
  var entered = "";
  for(var i=0;i<6;i++) entered += document.getElementById("otp"+i).value;
  var errEl = document.getElementById("verify-error");
  errEl.classList.add("hidden");

  if(entered.length < 6) {
    errEl.textContent = "Please enter all 6 digits.";
    errEl.classList.remove("hidden"); return;
  }
  if(Date.now() > otpExpiry) {
    errEl.textContent = "This code has expired. Please request a new one.";
    errEl.classList.remove("hidden"); return;
  }
  if(entered !== currentOtp) {
    /* Shake all digits */
    for(var j=0;j<6;j++){
      var d=document.getElementById("otp"+j);
      d.className="otp-digit error";
      d.value="";
      setTimeout(function(el){ return function(){ el.className="otp-digit"; }; }(d), 600);
    }
    document.getElementById("otp0").focus();
    errEl.textContent = "Incorrect code. Please try again.";
    errEl.classList.remove("hidden"); return;
  }

  /* âœ… Verified! Save user to Firebase + local DB then launch */
  clearInterval(otpExpiryTimer);
  clearInterval(resendTimer);
  pendingUser.emailVerified = true;

  /* Save to Firebase Firestore */
  if(window.fbDb && window.fbCreateUser) {
    try {
      var fbResult = await window.fbCreateUser(window.fbAuth, pendingUser.email, pendingUser._plainPassword);
      var fbUid = fbResult.user.uid;
      await window.fbSetDoc(window.fbDoc(window.fbDb, "users", fbUid), {
        name:      pendingUser.name,
        email:     pendingUser.email,
        role:      pendingUser.role,
        track:     pendingUser.track,
        status:    pendingUser.status,
        mentor_id: pendingUser.mentor_id,
        createdAt: new Date().toISOString()
      });
      console.log("âœ… User saved to Firebase!");
    } catch(fbErr) {
      console.warn("Firebase note:", fbErr.message);
    }
  }

  /* Keep reference before clearing */
  var verifiedUser = pendingUser;
  pendingUser  = null;
  currentOtp   = null;

  DB.users.push(verifiedUser);
  document.getElementById("verify-page").classList.add("hidden");
  createSession(verifiedUser, false);
  launchApp(verifiedUser, false);
  showToast("Email verified! Welcome, " + verifiedUser.name.split(" ")[0] + " ğŸ‰");
}

/* â”€â”€ Resend OTP â”€â”€ */
async function resendOtp() {
  if(!pendingUser) return;
  currentOtp = generateOtp();
  otpExpiry  = Date.now() + OTP_TTL_MS;
  startOtpExpiry();
  startResendCooldown();
  for(var i=0;i<6;i++) document.getElementById("otp"+i).value="";
  document.getElementById("otp0").focus();
  document.getElementById("verify-error").classList.add("hidden");
  var btn = document.getElementById("verify-btn");
  btn.innerHTML = '<span class="spinner"></span> Sendingâ€¦';
  btn.classList.add("login-loading");
  try {
    await sendOtpEmail(pendingUser, currentOtp);
    showToast("New code sent to " + pendingUser.email);
  } catch(err) {
    showToast("Failed to send email. Check EmailJS config.", "error");
    console.error("EmailJS error:", err);
  }
  btn.innerHTML = "Verify & Activate â†’";
  btn.classList.remove("login-loading");
}

/* â”€â”€ Cancel verify â”€â”€ */
function cancelVerify() {
  clearInterval(otpExpiryTimer);
  clearInterval(resendTimer);
  pendingUser = null; currentOtp = null;
  document.getElementById("verify-page").classList.add("hidden");
  document.getElementById("login-page").classList.remove("hidden");
}

/* â”€â”€ SIGNUP (updated to trigger email verification) â”€â”€ */
async function doSignup() {
  if(!AUTH_READY){ showToast("Initialisingâ€¦","error"); return; }
  var name    = document.getElementById("su-name").value.trim();
  var email   = document.getElementById("su-email").value.trim();
  var track   = document.getElementById("su-track").value;
  var pass    = document.getElementById("su-password").value;
  var confirm = document.getElementById("su-confirm").value;
  var errEl   = document.getElementById("signup-error");
  var btn     = document.getElementById("signup-btn");

  function signupErr(msg){ errEl.textContent=msg; errEl.classList.remove("hidden"); }
  errEl.classList.add("hidden");

  if(!name || !email || !track || !pass || !confirm)
    return signupErr("Please fill in all fields.");
  if(name.trim().length < 2)
    return signupErr("Please enter your full name.");
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
    return signupErr("Please enter a valid email address.");
  if(DB.users.find(function(u){ return u.email===email; }))
    return signupErr("An account with this email already exists.");
  if(pass.length < 8)
    return signupErr("Password must be at least 8 characters.");
  if(pwStrength(pass) < 2)
    return signupErr("Password is too weak. Add uppercase letters, numbers or symbols.");
  if(pass !== confirm)
    return signupErr("Passwords do not match.");

  btn.innerHTML = '<span class="spinner"></span> Sending verification emailâ€¦';
  btn.classList.add("login-loading");

  var hashed        = "$hash$" + await sha256(pass);
  var defaultMentor = DB.mentors[0] ? DB.mentors[0].id : null;

  /* Build user but DON'T push to DB yet â€” wait for email verification */
  pendingUser = {
    id: Date.now(), name: name, email: email, password: hashed,
    _plainPassword: pass,
    role: "student", mentor_id: defaultMentor, status: "Active", track: track,
    emailVerified: false
  };
  currentOtp = generateOtp();
  otpExpiry  = Date.now() + OTP_TTL_MS;

  try {
    await sendOtpEmail(pendingUser, currentOtp);
  } catch(err) {
    btn.innerHTML = "Create Account â†’";
    btn.classList.remove("login-loading");
    console.error("EmailJS send error:", err);
    /* Still show OTP page â€” OTP shown in console / toast in dev mode */
    if(!EMAILJS_CONFIGURED){
      showVerifyPage(pendingUser);
      return;
    }
    return signupErr("Failed to send verification email. Please check your EmailJS configuration.");
  }

  btn.innerHTML = "Create Account â†’";
  btn.classList.remove("login-loading");
  showVerifyPage(pendingUser);
}

/* â”€â”€ Google Sign-In â”€â”€ */
async function doGoogleSignIn() {
  if(!window.fbAuth || !window.fbSignInWithPopup) {
    showToast("Firebase not ready. Please wait.", "error"); return;
  }
  try {
    var result = await window.fbSignInWithPopup(window.fbAuth, window.fbGoogleProvider);
    var fbUser = result.user;

    /* Check if user already exists in our DB */
    var existing = DB.users.find(function(u){ return u.email === fbUser.email; });
    if(existing) {
      /* Existing user â€” log them in with remember=true */
      createSession(existing, true);
      launchApp(existing, true);
      showToast("Welcome back, " + existing.name.split(" ")[0] + "! ğŸ‘‹");
      return;
    }

    /* New user â€” create student account */
    var newUser = {
      id:            Date.now(),
      name:          fbUser.displayName || fbUser.email.split("@")[0],
      email:         fbUser.email,
      password:      "$hash$google",
      role:          "student",
      mentor_id:     DB.mentors[0] ? DB.mentors[0].id : null,
      status:        "Active",
      track:         "Software Development",
      emailVerified: true
    };

    /* Save to Firestore */
    try {
      await window.fbSetDoc(window.fbDoc(window.fbDb, "users", fbUser.uid), {
        name:      newUser.name,
        email:     newUser.email,
        role:      newUser.role,
        track:     newUser.track,
        status:    newUser.status,
        createdAt: new Date().toISOString(),
        provider:  "google"
      });
    } catch(e) { console.warn("Firestore save failed:", e.message); }

    DB.users.push(newUser);
    createSession(newUser, true); /* remember=true saves to localStorage */
    launchApp(newUser, true);
    showToast("Welcome, " + newUser.name.split(" ")[0] + "! ğŸ‰");

  } catch(err) {
    var silent = ["auth/popup-closed-by-user", "auth/cancelled-popup-request"];
    if(!silent.includes(err.code)) {
      showToast("Google sign-in failed: " + err.message, "error");
      console.error("Google sign-in error:", err);
    }
  }
}

/* â”€â”€ Shake keyframe â”€â”€ */
var shakeStyle = document.createElement("style");
shakeStyle.textContent = "@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}";
document.head.appendChild(shakeStyle);

/* â”€â”€ Load data from Firebase Firestore â”€â”€ */
async function loadFirestoreData() {
  if(!window.fbDb) return;
  try {
    /* Load users */
    var usersSnap = await window.fbGetDocs(window.fbCollection(window.fbDb, "users"));
    var firestoreUsers = [];
    usersSnap.forEach(function(doc) {
      var data = doc.data();
      firestoreUsers.push({
        id:        doc.id,
        name:      data.name      || "",
        email:     data.email     || "",
        role:      data.role      || "student",
        track:     data.track     || "",
        status:    data.status    || "Active",
        mentor_id: data.mentor_id || DB.mentors[0].id,
        password:  "$hash$firebase"
      });
    });
    if(firestoreUsers.length > 0) {
      /* Keep demo admin accounts, merge with firestore users */
      var admins = DB.users.filter(function(u){ return u.role === "admin"; });
      var firestoreEmails = firestoreUsers.map(function(u){ return u.email; });
      var nonDuplicateAdmins = admins.filter(function(a){ return !firestoreEmails.includes(a.email); });
      DB.users = nonDuplicateAdmins.concat(firestoreUsers);
    }

    /* Load projects */
    var projectsSnap = await window.fbGetDocs(window.fbCollection(window.fbDb, "projects"));
    var firestoreProjects = [];
    projectsSnap.forEach(function(doc) {
      var data = doc.data();
      firestoreProjects.push({
        id:          doc.id,
        student_id:  data.student_id  || "",
        title:       data.title       || "",
        github_link: data.github_link || "",
        description: data.description || "",
        feedback:    data.feedback    || "",
        status:      data.status      || "Pending",
        mark:        data.mark        || null,
        submitted:   data.submitted   || TODAY
      });
    });
    if(firestoreProjects.length > 0) DB.projects = firestoreProjects;

    /* Load attendance */
    var attSnap = await window.fbGetDocs(window.fbCollection(window.fbDb, "attendance"));
    var firestoreAtt = [];
    attSnap.forEach(function(doc) {
      var data = doc.data();
      firestoreAtt.push({
        id:         doc.id,
        student_id: data.student_id || "",
        date:       data.date       || "",
        status:     data.status     || "Present"
      });
    });
    if(firestoreAtt.length > 0) DB.attendance = firestoreAtt;

    console.log("âœ… Data loaded from Firestore!");
  } catch(err) {
    console.warn("Firestore load failed, using local data:", err.message);
  }
}

/* â”€â”€ Save new project to Firestore â”€â”€ */
async function saveProjectToFirestore(project) {
  if(!window.fbDb) return;
  try {
    await window.fbAddDoc(window.fbCollection(window.fbDb, "projects"), project);
  } catch(e) { console.warn("Project save failed:", e.message); }
}

/* â”€â”€ Save attendance to Firestore â”€â”€ */
async function saveAttendanceToFirestore(record) {
  if(!window.fbDb) return;
  try {
    await window.fbAddDoc(window.fbCollection(window.fbDb, "attendance"), record);
  } catch(e) { console.warn("Attendance save failed:", e.message); }
}

/* â”€â”€ INIT on page load â”€â”€ */
document.addEventListener("DOMContentLoaded", function(){
  /* Wait for Firebase module to load before initialising auth */
  var attempts = 0;
  var waitForFirebase = setInterval(function(){
    attempts++;
    if(window.firebaseReady || attempts > 20){
      clearInterval(waitForFirebase);
      /* Load Firestore data first then init auth */
      loadFirestoreData().then(function(){
        initAuth();
        var ls = document.getElementById("loading-screen");
        if(ls) ls.style.display = "none";
      });
    }
  }, 100);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSidebar() {
  var nav=currentUser.role==="admin"
    ?[["dashboard","ğŸ“Š","Dashboard"],["students","ğŸ‘¥","Students"],["attendance","ğŸ“…","Attendance"],["projects","ğŸ“","Projects"]]
    :[["dashboard","ğŸ ","My Dashboard"],["attendance","ğŸ“…","My Attendance"],["projects","ğŸ“","My Projects"]];
  var html="";
  nav.forEach(function(n){
    html+='<button class="nav-btn'+(activeNav===n[0]?" active":"") +'" onclick="goTo(\''+n[0]+'\')">'+n[1]+" "+n[2]+'</button>';
  });
  document.getElementById("sidebar-nav").innerHTML=html;
}

function goTo(page) {
  activeNav=page; buildSidebar(); renderPage();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ROUTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPage() {
  var m=document.getElementById("main");
  if     (activeNav==="dashboard" &&currentUser.role==="admin")   m.innerHTML=renderAdminDashboard();
  else if(activeNav==="dashboard" &&currentUser.role==="student")  m.innerHTML=renderStudentDashboard();
  else if(activeNav==="students"  &&currentUser.role==="admin")    m.innerHTML=renderStudentsPage();
  else if(activeNav==="attendance"&&currentUser.role==="admin")    m.innerHTML=renderAdminAttendance();
  else if(activeNav==="attendance"&&currentUser.role==="student")  m.innerHTML=renderStudentAttendance();
  else if(activeNav==="projects"  &&currentUser.role==="admin")    m.innerHTML=renderAdminProjects();
  else if(activeNav==="projects"  &&currentUser.role==="student")  m.innerHTML=renderStudentProjects();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAdminDashboard() {
  var s=getStudents();
  var active=s.filter(function(x){ return x.status==="Active"; }).length;
  var risk  =s.filter(function(x){ return x.status==="At Risk"; }).length;
  var done  =s.filter(function(x){ return x.status==="Completed"; }).length;

  var html='<div class="page-header"><h1>Dashboard</h1><p>Welcome back, '+currentUser.name.split(" ")[0]+'. Programme overview.</p></div>'
    +'<div class="stat-grid">'
    +statCardHTML("ğŸ‘¥","Total Students",s.length,"#6366f1")
    +statCardHTML("âœ…","Active",active,"#22c55e")
    +statCardHTML("âš ï¸","At Risk",risk,"#f59e0b")
    +statCardHTML("ğŸ†","Completed",done,"#3b82f6")
    +'</div>'
    +'<div class="two-col">';

  /* Recent Students */
  html+='<div class="card"><div class="section-title">Recent Students</div>';
  s.slice(0,5).forEach(function(x){
    html+='<div class="flex-row" style="padding:10px 0;border-bottom:1px solid #1e293b;">'
      +makeAvatar(x.name)
      +'<div class="flex-1"><div style="font-weight:700;font-size:14px;">'+x.name+'</div><div class="text-muted">'+x.track+'</div></div>'
      +statusBadge(x.status)+'</div>';
  });
  html+='<button class="btn btn-ghost btn-full" style="margin-top:14px;" onclick="goTo(\'students\')">View All Students â†’</button></div>';

  /* Recent Projects */
  html+='<div class="card"><div class="section-title">Recent Submissions</div>';
  DB.projects.slice(-4).reverse().forEach(function(p){
    var st=DB.users.find(function(u){ return u.id===p.student_id; });
    html+='<div class="flex-row" style="padding:10px 0;border-bottom:1px solid #1e293b;">'
      +'<div style="font-size:20px;">ğŸ“</div>'
      +'<div class="flex-1"><div style="font-weight:700;font-size:14px;">'+p.title+'</div><div class="text-muted">'+(st?st.name:"")+'</div></div>'
      +projectBadge(p.status)+'</div>';
  });
  html+='<button class="btn btn-ghost btn-full" style="margin-top:14px;" onclick="goTo(\'projects\')">View All Projects â†’</button></div></div>';

  /* At-Risk Alert */
  var risks=s.filter(function(x){ return x.status==="At Risk"; });
  if(risks.length){
    html+='<div class="alert-card"><div class="alert-title">âš  Students At Risk â€” Action Required</div>';
    risks.forEach(function(x){
      html+='<div class="flex-row" style="padding:10px 0;border-bottom:1px solid #1e293b40;">'
        +makeAvatar(x.name)
        +'<div class="flex-1"><div style="font-weight:700;">'+x.name+'</div>'
        +'<div class="text-muted">'+x.track+' Â· Mentor: '+getMentorName(x.mentor_id)+' Â· Attendance: '+getAttPct(x.id)+'%</div></div>'
        +'<button class="btn btn-success btn-sm" onclick="updateStatus('+x.id+',\'Active\')">Mark Active</button>'
        +'<button class="btn btn-blue btn-sm"    onclick="updateStatus('+x.id+',\'Completed\')">Mark Completed</button>'
        +'</div>';
    });
    html+='</div>';
  }
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStudentDashboard() {
  var u=currentUser, pct=getAttPct(u.id), proj=getProjects(u.id), today=getTodayAtt(u.id);

  var html='<div class="page-header"><h1>Welcome, '+u.name.split(" ")[0]+' ğŸ‘‹</h1>'
    +'<p>'+u.track+' Â· Mentor: '+getMentorName(u.mentor_id)+'</p></div>'
    +'<div class="stat-grid-3">'
    +statCardHTML("ğŸ“…","My Attendance",pct+"%","#6366f1")
    +statCardHTML("ğŸ“","Projects Submitted",proj.length,"#22c55e")
    +statCardHTML("ğŸ…","My Status",u.status,"#f59e0b")
    +'</div>';

  /* Today Attendance */
  html+='<div class="card"><div class="section-title">Today\'s Attendance â€” '+TODAY+'</div>';
  if(today){
    html+='<div class="today-box"><div style="font-size:32px;">'+(today.status==="Present"?"âœ…":"âŒ")+'</div>'
      +'<div><div style="font-weight:700;">You are marked <span style="color:'+(today.status==="Present"?"#22c55e":"#ef4444")+';">'+today.status+'</span> today.</div>'
      +'<div class="text-muted">Recorded for '+TODAY+'</div></div></div>';
  } else {
    html+='<div class="flex-row" style="padding:14px 0;">'
      +'<span class="flex-1 text-muted">You have not marked attendance today.</span>'
      +'<button class="btn btn-success" onclick="studentMarkAtt(\'Present\')">âœ… Mark Present</button>'
      +'<button class="btn btn-danger"  onclick="studentMarkAtt(\'Absent\')">âŒ Mark Absent</button>'
      +'</div>';
  }
  html+='</div>';

  /* My Projects */
  html+='<div class="card"><div class="flex-row" style="margin-bottom:16px;">'
    +'<div class="section-title" style="margin:0;flex:1;">My Project Submissions</div>'
    +'<button class="btn btn-primary btn-sm" onclick="openSubmitProject()">+ Submit Project</button></div>';
  if(!proj.length){
    html+='<div class="empty-state">No projects submitted yet.</div>';
  } else {
    proj.forEach(function(p){
      html+='<div style="padding:14px 0;border-bottom:1px solid #1e293b;">'
        +'<div class="flex-row" style="margin-bottom:6px;"><div style="font-weight:800;font-size:15px;flex:1;">'+p.title+'</div>'
        +'<div style="display:flex;gap:6px;align-items:center;">'+markBadge(p.mark)+projectBadge(p.status)+'</div></div>'
        +(p.mark!==null&&p.mark!==undefined?'<div style="margin-bottom:6px;">'+markBarHTML(p.mark)+'</div>':"")
        +'<div class="text-muted" style="margin-bottom:8px;">'+p.description+'</div>'
        +'<a class="gh-link" href="'+p.github_link+'" target="_blank">ğŸ”— '+p.github_link+'</a>'
        +(p.feedback?'<div class="feedback-block"><div class="feedback-label">MENTOR FEEDBACK</div><div style="font-size:14px;">'+p.feedback+'</div></div>':"")
        +'</div>';
    });
  }
  html+='</div>';
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENTS PAGE  (CRUD)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStudentsPage() {
  var s=getStudents();
  var html='<div class="page-header-row">'
    +'<div class="page-header" style="margin:0;"><h1>Students</h1><p>'+s.length+' learners registered</p></div>'
    +'<button class="btn btn-primary" onclick="openAddStudent()">+ Register Student</button></div>'
    +'<div class="table-wrap"><table><thead><tr>'
    +'<th>Student</th><th>Email</th><th>Track</th><th>Mentor</th><th>Status</th><th>Attendance</th><th>Actions</th>'
    +'</tr></thead><tbody>';

  if(!s.length){
    html+='<tr><td colspan="7" class="empty-state">No students registered yet.</td></tr>';
  } else {
    s.forEach(function(x){
      var pct=getAttPct(x.id);
      html+='<tr>'
        +'<td><div class="flex-row">'+makeAvatar(x.name,34)+'<span style="font-weight:700;">'+x.name+'</span></div></td>'
        +'<td class="text-muted">'+x.email+'</td>'
        +'<td class="text-muted">'+x.track+'</td>'
        +'<td class="text-muted">'+getMentorName(x.mentor_id)+'</td>'
        +'<td>'+statusBadge(x.status)+'</td>'
        +'<td style="font-weight:700;color:'+(pct>=70?"#22c55e":"#f59e0b")+';">'+pct+'%</td>'
        +'<td><div class="flex-row">'
        +'<button class="btn btn-ghost btn-sm" onclick="openEditStudent('+x.id+')">âœ Edit</button>'
        +'<button class="btn btn-danger btn-sm" onclick="deleteStudent('+x.id+')">ğŸ—‘ Delete</button>'
        +'</div></td></tr>';
    });
  }
  html+='</tbody></table></div>';
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN ATTENDANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAdminAttendance() {
  var s=getStudents();
  var presentToday=DB.attendance.filter(function(a){ return a.date===TODAY&&a.status==="Present"; }).length;

  var html='<div class="page-header"><h1>Attendance</h1><p>Mark and view attendance for all students</p></div>'
    +'<div class="table-wrap" style="margin-bottom:20px;">'
    +'<div style="padding:14px 20px;background:#0a0f1e;border-bottom:1px solid #1e293b;display:flex;justify-content:space-between;align-items:center;">'
    +'<span style="font-weight:700;">Mark Attendance â€” '+TODAY+'</span>'
    +'<span class="text-muted">'+presentToday+' present today</span></div>'
    +'<table><thead><tr><th>Student</th><th>Track</th><th>Today</th><th>Overall %</th><th>Mark</th></tr></thead><tbody>';

  s.forEach(function(x){
    var rec=getTodayAtt(x.id);
    html+='<tr>'
      +'<td><div class="flex-row">'+makeAvatar(x.name,32)+'<span style="font-weight:600;">'+x.name+'</span></div></td>'
      +'<td class="text-muted">'+x.track+'</td>'
      +'<td>'+(rec?attBadge(rec.status):'<span class="text-muted">Not marked</span>')+'</td>'
      +'<td style="font-weight:700;color:'+(getAttPct(x.id)>=70?"#22c55e":"#f59e0b")+';">'+getAttPct(x.id)+'%</td>'
      +'<td><div class="flex-row">'
      +'<button class="btn btn-success btn-sm" onclick="adminMarkAtt('+x.id+',\'Present\')">âœ“ Present</button>'
      +'<button class="btn btn-danger btn-sm"  onclick="adminMarkAtt('+x.id+',\'Absent\')">âœ• Absent</button>'
      +'</div></td></tr>';
  });
  html+='</tbody></table></div>';

  /* History */
  html+='<div class="card"><div class="section-title">Attendance History â€” All Students</div>';
  s.forEach(function(x){
    var recs=getAttendance(x.id);
    html+='<div style="margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid #1e293b;">'
      +'<div class="flex-row" style="margin-bottom:8px;">'
      +'<span style="font-weight:700;flex:1;">'+x.name+' <span class="text-muted">('+x.track+')</span></span>'
      +'<span style="font-weight:800;color:'+(getAttPct(x.id)>=70?"#22c55e":"#f59e0b")+';">'+getAttPct(x.id)+'%</span>'
      +'</div><div>';
    if(!recs.length){ html+='<span class="text-muted">No records</span>'; }
    recs.forEach(function(r){
      html+='<span class="att-chip '+(r.status==="Present"?"att-present":"att-absent")+'">'+r.date+' Â· '+r.status+'</span>';
    });
    html+='</div></div>';
  });
  html+='</div>';
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT ATTENDANCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStudentAttendance() {
  var u=currentUser, recs=getAttendance(u.id);
  var pres=recs.filter(function(r){ return r.status==="Present"; }).length;
  var abs =recs.filter(function(r){ return r.status==="Absent";  }).length;
  var pct =getAttPct(u.id), today=getTodayAtt(u.id);

  var html='<div class="page-header"><h1>My Attendance</h1><p>Your personal attendance history and stats</p></div>'
    +'<div class="card" style="margin-bottom:20px;">'
    +'<div class="flex-row" style="justify-content:space-between;margin-bottom:14px;">'
    +'<div class="section-title" style="margin:0;">Today â€” '+TODAY+'</div>'
    +'<div class="flex-row">'
    +'<button class="btn btn-success btn-sm" onclick="studentMarkAtt(\'Present\')">âœ… Mark Present</button>'
    +'<button class="btn btn-danger btn-sm"  onclick="studentMarkAtt(\'Absent\')">âŒ Mark Absent</button>'
    +'</div></div>';

  if(today){
    html+='<div class="today-box"><div style="font-size:28px;">'+(today.status==="Present"?"âœ…":"âŒ")+'</div>'
      +'<div><div style="font-weight:700;">Marked <span style="color:'+(today.status==="Present"?"#22c55e":"#ef4444")+';">'+today.status+'</span> today</div></div></div>';
  } else {
    html+='<div class="text-muted" style="padding:10px 0;">Not yet marked for today.</div>';
  }
  html+='</div>';

  html+='<div class="mini-stats">'
    +'<div class="mini-stat"><div class="mini-stat-val" style="color:#22c55e;">'+pres+'</div><div class="mini-stat-lbl">Days Present</div></div>'
    +'<div class="mini-stat"><div class="mini-stat-val" style="color:#ef4444;">'+abs+'</div><div class="mini-stat-lbl">Days Absent</div></div>'
    +'<div class="mini-stat"><div class="mini-stat-val" style="color:#6366f1;">'+pct+'%</div><div class="mini-stat-lbl">Overall Rate</div></div>'
    +'</div>';

  html+='<div class="card" style="margin-top:20px;"><div class="section-title">My History</div>';
  if(!recs.length){
    html+='<div class="empty-state">No attendance records yet.</div>';
  } else {
    recs.forEach(function(r){
      html+='<div class="flex-row" style="padding:11px 14px;background:#0a0f1e;border-radius:10px;margin-bottom:8px;">'
        +'<span class="flex-1 text-muted">'+r.date+'</span>'+attBadge(r.status)+'</div>';
    });
  }
  html+='</div>';
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PROJECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAdminProjects() {
  var html='<div class="page-header"><h1>Projects</h1><p>Review, mark and grade student project submissions</p></div>';
  if(!DB.projects.length){ return html+'<div class="empty-state">No submissions yet.</div>'; }
  DB.projects.forEach(function(p){
    var st=DB.users.find(function(u){ return u.id===p.student_id; });
    html+='<div class="card">'
      +'<div class="flex-row" style="margin-bottom:10px;">'
      +'<div class="flex-1"><div style="font-weight:800;font-size:16px;">'+p.title+'</div>'
      +'<div class="text-muted">By: <strong style="color:#e2e8f0;">'+(st?st.name:"")+'</strong> Â· '+p.submitted+'</div></div>'
      +'<div style="display:flex;align-items:center;gap:8px;">'+markBadge(p.mark)+projectBadge(p.status)+'</div></div>'
      +(p.mark!==null&&p.mark!==undefined?'<div style="margin-bottom:10px;">'+markBarHTML(p.mark)+'<div style="font-size:11px;color:#64748b;margin-top:4px;font-weight:700;">'+markLabel(p.mark)+'</div></div>':"")
      +'<div class="text-muted" style="margin-bottom:12px;">'+p.description+'</div>'
      +'<a class="gh-link" href="'+p.github_link+'" target="_blank">ğŸ”— View on GitHub</a>'
      +(p.feedback?'<div class="feedback-block"><div class="feedback-label">FEEDBACK</div><div style="font-size:14px;">'+p.feedback+'</div></div>':"")
      +'<div class="flex-row mt-14 pt-14 border-t">'
      +'<button class="btn btn-primary btn-sm" onclick="openReview('+p.id+')">âœ Review &amp; Grade</button>'
      +'</div></div>';
  });
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT PROJECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStudentProjects() {
  var proj=getProjects(currentUser.id);
  var html='<div class="page-header-row">'
    +'<div class="page-header" style="margin:0;"><h1>My Projects</h1><p>Your submitted projects and mentor feedback</p></div>'
    +'<button class="btn btn-primary" onclick="openSubmitProject()">+ Submit Project</button></div>';
  if(!proj.length){ return html+'<div class="empty-state">No projects submitted yet. Click "+ Submit Project" to get started.</div>'; }
  proj.forEach(function(p){
    html+='<div class="card">'
      +'<div class="flex-row" style="margin-bottom:8px;"><div style="font-weight:800;font-size:16px;flex:1;">'+p.title+'</div>'
      +'<div style="display:flex;gap:8px;align-items:center;">'+markBadge(p.mark)+projectBadge(p.status)+'</div></div>'
      +(p.mark!==null&&p.mark!==undefined?'<div style="margin-bottom:10px;">'+markBarHTML(p.mark)+'<div style="font-size:11px;color:#64748b;margin-top:4px;font-weight:700;">'+markLabel(p.mark)+'</div></div>':"")
      +'<div class="text-muted" style="margin-bottom:10px;">'+p.description+'</div>'
      +'<div class="text-muted" style="font-size:12px;margin-bottom:10px;">Submitted: '+p.submitted+'</div>'
      +'<a class="gh-link" href="'+p.github_link+'" target="_blank">ğŸ”— '+p.github_link+'</a>'
      +(p.feedback?'<div class="feedback-block"><div class="feedback-label">MENTOR FEEDBACK</div><div style="font-size:14px;">'+p.feedback+'</div></div>':"")
      +'</div>';
  });
  return html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DB ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateStatus(id, status) {
  DB.users=DB.users.map(function(u){ return u.id===id?Object.assign({},u,{status:status}):u; });
  showToast("Status updated to "+status+"!"); renderPage();
}
function deleteStudent(id) {
  if(!confirm("Remove this student?")) return;
  DB.users=DB.users.filter(function(u){ return u.id!==id; });
  showToast("Student removed.","error"); renderPage();
}
function adminMarkAtt(sid,status)  { saveAtt(sid,status); showToast("Marked as "+status); renderPage(); }
function studentMarkAtt(status)    { saveAtt(currentUser.id,status); showToast("Marked as "+status); renderPage(); }
function saveAtt(sid,status) {
  var i=DB.attendance.findIndex(function(a){ return a.student_id===sid&&a.date===TODAY; });
  if(i>=0){ DB.attendance[i].status=status; }
  else { DB.attendance.push({id:Date.now(),student_id:sid,date:TODAY,status:status}); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: ADD STUDENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var TRACKS=["Software Development","Data Science","UX Design","Cloud Computing","Cybersecurity"];
function openAddStudent() {
  var mo=DB.mentors.map(function(m){ return '<option value="'+m.id+'">'+m.name+'</option>'; }).join("");
  var to=TRACKS.map(function(t){ return '<option>'+t+'</option>'; }).join("");
  openModal("Register New Student",
    '<div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="f-name" placeholder="e.g. Thandeka Zulu"/></div>'
    +'<div class="form-group"><label class="form-label">Email Address</label><input class="form-input" id="f-email" type="email" placeholder="e.g. thandeka@email.com"/></div>'
    +'<div class="form-group"><label class="form-label">Track / Programme</label><select class="form-input" id="f-track">'+to+'</select></div>'
    +'<div class="form-group"><label class="form-label">Assign Mentor</label><select class="form-input" id="f-mentor">'+mo+'</select></div>'
    +'<div class="modal-btn-row"><button class="btn btn-primary flex-1" onclick="saveNewStudent()">Register Student</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>'
  );
}
function saveNewStudent() {
  var name=document.getElementById("f-name").value.trim();
  var email=document.getElementById("f-email").value.trim();
  if(!name||!email){ alert("Please fill in all fields."); return; }
  DB.users.push({id:Date.now(),name:name,email:email,password:"student123",role:"student",
    mentor_id:parseInt(document.getElementById("f-mentor").value),
    status:"Active",track:document.getElementById("f-track").value});
  showToast("Student registered!"); closeModal(); renderPage();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: EDIT STUDENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openEditStudent(id) {
  var s=DB.users.find(function(u){ return u.id===id; });
  var mo=DB.mentors.map(function(m){ return '<option value="'+m.id+'"'+(m.id===s.mentor_id?" selected":"")+'>'+m.name+'</option>'; }).join("");
  var to=TRACKS.map(function(t){ return '<option'+(t===s.track?" selected":"")+'>'+t+'</option>'; }).join("");
  var so=["Active","At Risk","Completed"].map(function(v){ return '<option'+(v===s.status?" selected":"")+'>'+v+'</option>'; }).join("");
  openModal("Edit Student",
    '<div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="e-name" value="'+s.name+'"/></div>'
    +'<div class="form-group"><label class="form-label">Email Address</label><input class="form-input" id="e-email" type="email" value="'+s.email+'"/></div>'
    +'<div class="form-group"><label class="form-label">Track / Programme</label><select class="form-input" id="e-track">'+to+'</select></div>'
    +'<div class="form-group"><label class="form-label">Assign Mentor</label><select class="form-input" id="e-mentor">'+mo+'</select></div>'
    +'<div class="form-group"><label class="form-label">Status</label><select class="form-input" id="e-status">'+so+'</select></div>'
    +'<div class="modal-btn-row"><button class="btn btn-primary flex-1" onclick="saveEditStudent('+id+')">Save Changes</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>'
  );
}
function saveEditStudent(id) {
  var name=document.getElementById("e-name").value.trim();
  var email=document.getElementById("e-email").value.trim();
  if(!name||!email){ alert("Please fill in all fields."); return; }
  DB.users=DB.users.map(function(u){
    return u.id===id?Object.assign({},u,{name:name,email:email,track:document.getElementById("e-track").value,
      mentor_id:parseInt(document.getElementById("e-mentor").value),status:document.getElementById("e-status").value}):u;
  });
  showToast("Student updated!"); closeModal(); renderPage();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: SUBMIT PROJECT (student)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSubmitProject() {
  openModal("Submit Project",
    '<div class="form-group"><label class="form-label">Project Title</label><input class="form-input" id="p-title" placeholder="e.g. REST API with Node.js"/></div>'
    +'<div class="form-group"><label class="form-label">GitHub Link</label><input class="form-input" id="p-link" placeholder="https://github.com/username/repo"/></div>'
    +'<div class="form-group"><label class="form-label">Short Description</label><textarea class="form-input" id="p-desc" rows="3" placeholder="Briefly describe your project..."></textarea></div>'
    +'<div class="modal-btn-row"><button class="btn btn-primary flex-1" onclick="saveProject()">Submit Project</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>'
  );
}
function saveProject() {
  var title=document.getElementById("p-title").value.trim();
  var link =document.getElementById("p-link").value.trim();
  var desc =document.getElementById("p-desc").value.trim();
  if(!title||!link){ alert("Please fill in the title and GitHub link."); return; }
  var newProject = {student_id:currentUser.id,title:title,github_link:link,description:desc,feedback:"",status:"Pending",submitted:TODAY};
  DB.projects.push(Object.assign({id:Date.now()}, newProject));
  saveProjectToFirestore(newProject);
  showToast("Project submitted!"); closeModal(); renderPage();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: REVIEW PROJECT (admin)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openReview(id) {
  var p=DB.projects.find(function(x){ return x.id===id; });
  var st=DB.users.find(function(u){ return u.id===p.student_id; });
  var currentMark=p.mark!==null&&p.mark!==undefined?p.mark:"";
  openModal("Review: "+p.title,
    '<div style="background:#0a0f1e;border-radius:10px;padding:12px 14px;margin-bottom:18px;font-size:13px;color:#64748b;">'
    +'<span style="font-weight:700;color:#e2e8f0;">'+(st?st.name:"")+'</span> Â· '+p.submitted
    +'</div>'
    +'<div class="form-group"><label class="form-label">Mark (0 â€“ 100)</label>'
    +'<input class="form-input" id="r-mark" type="number" min="0" max="100" placeholder="Enter score e.g. 78" value="'+currentMark+'" oninput="previewStatus()" style="font-size:22px;font-weight:800;text-align:center;"/>'
    +'<div id="mark-preview" style="margin-top:8px;text-align:center;font-size:12px;color:#64748b;">Enter a mark to preview the status</div>'
    +'<div id="mark-bar-preview" style="margin-top:6px;"></div></div>'
    +'<div class="form-group"><label class="form-label">Feedback for Student</label>'
    +'<textarea class="form-input" id="r-feedback" rows="4" placeholder="Write your feedback here...">'+p.feedback+'</textarea></div>'
    +'<div style="background:#6366f110;border:1px solid #6366f130;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:#818cf8;">'
    +'<strong>Grading Guide:</strong> 75â€“100 â†’ Approved &nbsp;|&nbsp; 50â€“74 â†’ Needs Improvement &nbsp;|&nbsp; 0â€“49 â†’ Needs Improvement'
    +'</div>'
    +'<div class="modal-btn-row"><button class="btn btn-primary flex-1" onclick="saveReview('+id+')">ğŸ’¾ Save Review &amp; Grade</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>'
  );
  if(currentMark!=="") previewStatus();
}
function previewStatus() {
  var v=parseInt(document.getElementById("r-mark").value);
  var prev=document.getElementById("mark-preview");
  var bar =document.getElementById("mark-bar-preview");
  if(isNaN(v)||v<0||v>100){ prev.textContent="Enter a mark between 0 and 100"; prev.style.color="#64748b"; bar.innerHTML=""; return; }
  var status=v>=75?"Approved":"Needs Improvement";
  var label =v>=75?"Distinction":v>=50?"Pass":"Below Pass";
  var color =v>=75?"#22c55e":v>=50?"#f59e0b":"#ef4444";
  prev.innerHTML='<span style="font-weight:800;color:'+color+';">'+v+'/100 â€” '+label+' â†’ Status will be set to "'+status+'"</span>';
  bar.innerHTML='<div class="mark-bar-wrap"><div class="mark-bar-fill" style="width:'+v+'%;background:'+color+';"></div></div>';
}
function saveReview(id) {
  var markVal=document.getElementById("r-mark").value;
  var feedback=document.getElementById("r-feedback").value.trim();
  var mark=markVal===""?null:parseInt(markVal);
  if(mark!==null&&(isNaN(mark)||mark<0||mark>100)){ alert("Please enter a valid mark between 0 and 100."); return; }
  /* Auto-determine status from mark */
  var status=mark===null?"Pending":mark>=75?"Approved":"Needs Improvement";
  DB.projects=DB.projects.map(function(p){
    return p.id===id?Object.assign({},p,{status:status,feedback:feedback,mark:mark}):p;
  });
  /* Also update student status: if all reviewed projects are approved â†’ Active; if any below pass â†’ At Risk */
  var proj=DB.projects.filter(function(p){ return p.student_id===DB.projects.find(function(x){return x.id===id;}).student_id; });
  var anyLow=proj.some(function(p){ return p.mark!==null&&p.mark<50; });
  var allDone=proj.every(function(p){ return p.mark!==null; });
  if(anyLow){
    DB.users=DB.users.map(function(u){ return u.id===proj[0].student_id&&u.role==="student"?Object.assign({},u,{status:"At Risk"}):u; });
  } else if(allDone){
    DB.users=DB.users.map(function(u){ return u.id===proj[0].student_id&&u.role==="student"?Object.assign({},u,{status:"Active"}):u; });
  }
  showToast(mark!==null?"Review saved! Mark: "+mark+"/100 â€” "+status:"Review saved!"); closeModal(); renderPage();
}
</script>
</body>
</html>
